.. _powervm_inventory_module:


powervm_inventory -- HMC-based inventory source for Power Systems
=================================================================

.. contents::
   :local:
   :depth: 1


Synopsis
--------

This plugin utilizes HMC APIs to build a dynamic inventory of defined partitions (LPAR, VIOS). Inventory sources must be structured as *.power_hmc.yml or *.power_hmc.yaml.

To create a usable Ansible host for a given LPAR, the IP or hostname of the LPAR must be exposed through the HMC in some way. Currently there are only two such sources supported by this plugin, either an RMC IP address(not valid for IBMi partition) or the name of the LPAR must be also a valid hostname.

Valid LPAR/VIOS properties that can be used for groups, keyed groups, filters, unknown partition identification, and composite variables can be found in the HMC REST API documentation. By default, valid properties include those listed as "Quick Properties", but if `advanced_fields` are enabled, you may be able to use more advanced properties of the partition. Further information about the APIs can be found in the `Knowledge Center <https://www.ibm.com/support/knowledgecenter/9040-MR9/p9ehl/apis/LogicalPartition.htm>`_.

If a property is used in the inventory source that is unique to a partition type, only partitions for which that property is defined may be included. Non-compatible partitions can be filtered out by `OperatingSystemVersion` or `PartitionType` as detailed in the second example.



Requirements
------------
The below requirements are needed on the host that executes this module.

- Python >= 3



Parameters
----------

  hmc_hosts (True, dict, None)
    A dictionary of hosts and their associated usernames and passwords.


  filters (optional, any, {})
    A key value pair for filtering by various LPAR/VIOS attributes. Only results matching the filter will be included in the inventory.


  compose (optional, dict, {})
    Create vars from Jinja2 expressions.


  groups (optional, dict, {})
    Add hosts to group based on Jinja2 conditionals.


  keyed_groups (optional, list, [])
    Add hosts to group based on the values of a variable.


  exclude_ip (optional, list, [])
    A list of IP addresses to exclude from the inventory. This will be compared to the RMC IP address specified in the HMC. Currently, no hostname lookup is performed, so only IP addresses that match the RMC IP address specified in the HMC will be excluded. This is not valid for IBMi LPARs


  exclude_lpar (optional, list, [])
    A list of partitions (LPAR, VIOS) to exclude by partition name.


  exclude_system (optional, list, [])
    A list of HMC managed systems whose partitions (LPAR, VIOS) will be excluded from the dynamic inventory.


  ansible_display_name (optional, str, lpar_name)
    By default, partitions names will be used as the name displayed by Ansible in output. If you wish this to display the IP address instead you may set this to "ip".


  ansible_host_type (optional, str, ip)
    Determines if the ip address or the LPAR name will be used as the "ansible_host" variable in playbooks. This is not valid for IBMi LPARs


  advanced_fields (optional, bool, False)
    Allows for additional LPAR/VIOS properties to be used for the purposes of grouping and filtering.

    Retrieving these properties could increase dynamic inventory generation run time, depending on the size of your environment and the properties to be fetched.


  group_by_managed_system (optional, bool, True)
    Creates a grouping of partitions by managed system name. This is enabled by default.


  identify_unknown_by (optional, str, omit)
    Allows you to include partitions unable to be automatically detected as a valid Ansible target.

    By default, Aix/Linux partitions without IP's and IBMi partitions in not running state are omitted from the inventory. This is not be the case in the event you have lpar_name set for ansible_host_type. If not, omitted partitions will be added to a group called "unknown" and will can be identified by any LPAR property of your choosing (PartitionName or UUID are common identifiers).

    If you do not omit unknown partitions, you may run into issues targeting groups that include them. To avoid this, you can specify a host pattern in a playbooks such as `targetgroup:!unknown`. This will your playbook to run against all known hosts in your target group.









Examples
--------

.. code-block:: yaml+jinja

    
    # The most minimal example, targeting only a single HMC
    plugin: ibm.power_hmc.powervm_inventory
    hmc_hosts:
      "hmc_host_name":
        user: <HMC_Username>
        password: <HMC_Password>

    # Create an inventory consisting of only Virtual IO Servers.
    # This may be important if grouping by advanced_fields exclusive to VIOS.
    plugin: ibm.power_hmc.powervm_inventory
    hmc_hosts:
      "hmc_host_name":
        user: <HMC_Username>
        password: <HMC_Password>
    filters:
        PartitionType: 'Virtual IO Server'

    # Target multiple HMC hosts and only add running partitions to the inventory
    plugin: ibm.power_hmc.powervm_inventory
    hmc_hosts:
      "hmc_host_name":
        user: <HMC1_Username>
        password: <HMC1_Password>
      "hmc_host_name2":
        user: <HMC2_Username>
        password: <HMC2_Password>
    filters:
        PartitionState: 'running'

    # Generate an inventory of all running partitions and create a separate group for AIX 7.2 and IBMi type of partitions
    plugin: ibm.power_hmc.powervm_inventory
    hmc_hosts:
      "hmc_host_name":
        user: <HMC1_Username>
        password: <HMC1_Password>
      "hmc_host_name2":
        user: <HMC2_Username>
        password: <HMC2_Password>
    filters:
        PartitionState: 'running'
    groups:
        AIX_72: "'7.2' in OperatingSystemVersion"
        IBMi: "'IBM' in OperatingSystemVersion"

    # Generate an inventory of running partitions and group them by PartitionType with a prefix of type_
    # Groups will be created will resemble "type_Virtual_IO_Server", "type_AIX_Linux", "type_OS400", etc.
    # Additionally, include the following variables as host_vars for a given target host: CurrentMemory, OperatingSystemVersion, PartitionName
    plugin: ibm.power_hmc.powervm_inventory
    hmc_hosts:
      "hmc_host_name":
        user: <HMC1_Username>
        password: <HMC1_Password>
      "hmc_host_name2":
        user: <HMC2_Username>
        password: <HMC2_Password>
    filters:
        PartitionState: 'running'
    keyed_groups:
      - prefix: type
        key: PartitionType
    compose:
      current_memory: CurrentMemory
      os: OperatingSystemVersion
      name: PartitionName

    ## Generate an inventory that excludes partitions by ip, name, or the name of managed system on which they run
    plugin: ibm.power_hmc.powervm_inventory
    hmc_hosts:
      "hmc_host_name":
        user: <HMC2_Username>
        password: <HMC_Password>
    exclude_ip:
        - 10.0.0.44
        - 10.0.0.46
    exclude_lpar:
        - aixlparnameX1
        - aixlparnameX2
        - vioslparnameX1
        - vioslparnameX2
    exclude_system:
        - Frame1-XXX-WWWWWW
        - Frame2-XXX-WWWWWW





Status
------





Authors
~~~~~~~

- Torin Reilly (@torinreilly)
- Michael Cohoon (@mtcohoon)
- Ozzie Rodriguez
- Anil Vijayan
- Navinakumar Kandakur (@nkandak1)

